<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Government Organisation Hierarchy</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:opsz,wght@6..72,300;6..72,400;6..72,500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #f8f8f8;
            color: #1a1a1a;
            height: 100vh;
            font-weight: 300;
            overflow: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0.75rem 1rem;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            align-items: baseline;
            gap: 1.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        h1 {
            font-family: 'Newsreader', Georgia, serif;
            font-size: 1.3rem;
            font-weight: 400;
            letter-spacing: -0.02em;
            color: #0b0c0c;
            white-space: nowrap;
        }

        .subtitle {
            font-size: 0.75rem;
            color: #505a5f;
            line-height: 1.4;
        }

        .stats {
            display: flex;
            gap: 1.25rem;
            align-items: baseline;
        }

        .stat {
            display: flex;
            align-items: baseline;
            gap: 0.3rem;
        }

        .stat-value {
            font-family: 'Newsreader', serif;
            font-size: 1rem;
            font-weight: 400;
            color: #0b0c0c;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #6f777b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .chart-wrapper {
            position: relative;
            background: #fff;
            border: 1px solid #ddd;
            flex: 1;
            min-height: 0;
        }

        #chart {
            width: 100%;
            height: 100%;
        }

        .link {
            stroke: #c0c0c0;
            stroke-opacity: 0.4;
            fill: none;
        }

        .link.highlighted {
            stroke: #0b0c0c;
            stroke-opacity: 0.8;
            stroke-width: 1.5px;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 1px;
            cursor: pointer;
            transition: r 0.15s;
        }

        .node text {
            font-family: 'Inter', sans-serif;
            font-size: 9px;
            fill: #505a5f;
            pointer-events: none;
        }

        .node.dimmed circle {
            opacity: 0.15;
        }

        .node.dimmed text {
            opacity: 0.1;
        }

        .link.dimmed {
            stroke-opacity: 0.05;
        }

        .tier-labels-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .tier-label {
            position: absolute;
            left: 0.75rem;
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            color: #6f777b;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 400;
            background: rgba(255,255,255,0.85);
            padding: 0.15rem 0.4rem;
            white-space: nowrap;
        }

        .tier-line {
            stroke: #e8e8e8;
            stroke-width: 1px;
            stroke-dasharray: 4,4;
        }

        .detail-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 280px;
            background: #fff;
            border: 1px solid #ddd;
            padding: 1.25rem;
            display: none;
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .detail-panel.visible {
            display: block;
        }

        .detail-panel .detail-close {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            cursor: pointer;
            font-size: 1.1rem;
            color: #6f777b;
            background: none;
            border: none;
            font-family: 'Inter', sans-serif;
        }

        .detail-panel .detail-close:hover {
            color: #0b0c0c;
        }

        .detail-panel h3 {
            font-family: 'Newsreader', serif;
            font-size: 1.1rem;
            font-weight: 400;
            color: #0b0c0c;
            margin-bottom: 0.75rem;
            padding-right: 1.5rem;
            line-height: 1.3;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.8rem;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-key {
            color: #6f777b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.65rem;
        }

        .detail-value {
            color: #0b0c0c;
            text-align: right;
            max-width: 170px;
            word-break: break-word;
        }

        .detail-value a {
            color: #1d70b8;
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .zoom-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            z-index: 10;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: #fff;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #505a5f;
            font-family: 'Inter', sans-serif;
        }

        .zoom-btn:hover {
            background: #f3f3f3;
            color: #0b0c0c;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            align-items: center;
            margin-left: auto;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.65rem;
            color: #505a5f;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>UK Government Organisation Hierarchy</h1>
            <div class="stats">
                <div class="stat"><span class="stat-value">{{total_orgs}}</span><span class="stat-label">orgs</span></div>
                <div class="stat"><span class="stat-value">{{total_links}}</span><span class="stat-label">links</span></div>
                <div class="stat"><span class="stat-value">{{total_formats}}</span><span class="stat-label">types</span></div>
            </div>
            <div class="legend" id="legend"></div>
        </header>

        <div class="chart-wrapper">
            <svg id="chart"></svg>
            <div class="tier-labels-container" id="tier-labels"></div>

            <div class="detail-panel" id="detail-panel">
                <button class="detail-close" id="detail-close">&times;</button>
                <h3 id="detail-name"></h3>
                <div id="detail-body"></div>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-in">+</button>
                <button class="zoom-btn" id="zoom-out">&minus;</button>
                <button class="zoom-btn" id="zoom-reset">&#8634;</button>
            </div>
        </div>
    </div>

    <script>
        const graphData = {{graph_json}};

        const tierOrder = [
            "Ministerial department / Devolved government",
            "Non-ministerial department",
            "Executive agency / office",
            "Non-departmental body",
            "Tribunal / Court / Monitoring Body",
            "Other"
        ];

        const tierColours = [
            "#1d70b8",
            "#4c2c92",
            "#28a197",
            "#d53880",
            "#f47738",
            "#6f777b"
        ];

        // Map each format to its tier index
        const formatToTier = {};
        graphData.nodes.forEach(n => {
            if (formatToTier[n.format] === undefined) {
                formatToTier[n.format] = n.tier;
            }
        });

        // Build colour scale: map format -> tier colour
        const formatColour = (fmt) => tierColours[formatToTier[fmt]] || "#6f777b";

        // Build legend
        const legendEl = document.getElementById('legend');
        const seenFormats = new Map();
        graphData.nodes.forEach(n => {
            if (!seenFormats.has(n.format)) {
                seenFormats.set(n.format, n.tier);
            }
        });
        const sortedFormats = [...seenFormats.entries()].sort((a, b) => a[1] - b[1] || a[0].localeCompare(b[0]));
        sortedFormats.forEach(([fmt, tier]) => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            const dot = document.createElement('div');
            dot.className = 'legend-dot';
            dot.style.background = tierColours[tier];
            item.appendChild(dot);
            item.appendChild(document.createTextNode(fmt));
            legendEl.appendChild(item);
        });

        // SVG setup
        const svg = d3.select("#chart");
        const svgEl = svg.node();
        const width = svgEl.clientWidth;
        const height = svgEl.clientHeight;

        svg.attr("viewBox", [0, 0, width, height]);

        // Zoom
        const g = svg.append("g");

        const zoom = d3.zoom()
            .scaleExtent([0.1, 8])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
                if (typeof updateTierLabelPositions === "function") {
                    updateTierLabelPositions(event.transform);
                }
            });

        svg.call(zoom);

        document.getElementById("zoom-in").addEventListener("click", () => {
            svg.transition().duration(300).call(zoom.scaleBy, 1.4);
        });
        document.getElementById("zoom-out").addEventListener("click", () => {
            svg.transition().duration(300).call(zoom.scaleBy, 0.7);
        });
        document.getElementById("zoom-reset").addEventListener("click", () => {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        });

        // Tier bands — use a tall internal coordinate space for clear separation
        const internalHeight = 1000;
        const tierMargin = 60;
        const tierHeight = (internalHeight - tierMargin * 2) / tierOrder.length;

        function tierY(tierIdx) {
            return tierMargin + tierIdx * tierHeight + tierHeight / 2;
        }

        // Draw tier backgrounds
        const tierGroup = g.append("g").attr("class", "tiers");

        const tierLineWidth = 4000;

        tierOrder.forEach((label, i) => {
            const y = tierMargin + i * tierHeight;

            tierGroup.append("line")
                .attr("class", "tier-line")
                .attr("x1", -tierLineWidth / 2)
                .attr("y1", y)
                .attr("x2", tierLineWidth / 2)
                .attr("y2", y);

            // Tier label rendered as HTML overlay (see below)
        });

        // Bottom tier line
        tierGroup.append("line")
            .attr("class", "tier-line")
            .attr("x1", -tierLineWidth / 2)
            .attr("y1", tierMargin + tierOrder.length * tierHeight)
            .attr("x2", tierLineWidth / 2)
            .attr("y2", tierMargin + tierOrder.length * tierHeight);

        // HTML tier labels (fixed overlay, not affected by zoom)
        const tierLabelsEl = document.getElementById("tier-labels");
        const tierLabelEls = [];
        tierOrder.forEach((label, i) => {
            if (!label) return;
            const div = document.createElement("div");
            div.className = "tier-label";
            div.textContent = label;
            div.dataset.tier = i;
            tierLabelsEl.appendChild(div);
            tierLabelEls.push({ el: div, tier: i });
        });

        function updateTierLabelPositions(transform) {
            const t = transform || d3.zoomIdentity;
            tierLabelEls.forEach(({ el, tier }) => {
                const yInternal = tierMargin + tier * tierHeight + tierHeight / 2;
                const yScreen = t.applyY(yInternal);
                el.style.top = (yScreen - 8) + "px";
            });
        }
        updateTierLabelPositions();

        // Build adjacency for highlighting
        const linkedByIndex = new Set();
        graphData.links.forEach(l => {
            linkedByIndex.add(l.source + "," + l.target);
            linkedByIndex.add(l.target + "," + l.source);
        });

        function isConnected(a, b) {
            return a === b || linkedByIndex.has(a + "," + b);
        }

        // Links
        const link = g.append("g")
            .selectAll("line")
            .data(graphData.links)
            .join("line")
            .attr("class", "link")
            .attr("stroke-width", 0.5);

        // Nodes
        const node = g.append("g")
            .selectAll("g")
            .data(graphData.nodes)
            .join("g")
            .attr("class", "node");

        node.append("circle")
            .attr("r", d => d.radius)
            .attr("fill", d => formatColour(d.format));

        node.append("text")
            .attr("dx", d => d.radius + 3)
            .attr("dy", "0.35em")
            .text(d => d.tier === 0 && d.abbrev ? d.abbrev : d.name)
            .style("font-size", d => d.radius > 5 ? "9px" : "7px")
            .style("display", d => d.tier === 0 ? "block" : "none");

        // Highlight helpers
        let pinnedNode = null;

        function applyHighlight(d) {
            node.classed("dimmed", o => !isConnected(d.id, o.id));
            link.classed("dimmed", l => l.source.id !== d.id && l.target.id !== d.id);
            link.classed("highlighted", l => l.source.id === d.id || l.target.id === d.id);
            node.select("text").style("display", o => isConnected(d.id, o.id) ? "block" : (o.tier === 0 ? "block" : "none"));
        }

        function clearHighlight() {
            node.classed("dimmed", false);
            link.classed("dimmed", false);
            link.classed("highlighted", false);
            node.select("text").style("display", d => d.tier === 0 ? "block" : "none");
        }

        // Hover behaviour
        node.on("mouseenter", function(event, d) {
            applyHighlight(d);
        });

        node.on("mouseleave", function() {
            // If a node is pinned, revert to its highlight; otherwise clear
            if (pinnedNode) {
                applyHighlight(pinnedNode);
            } else {
                clearHighlight();
            }
        });

        // Click to show details and pin highlight
        const detailPanel = document.getElementById("detail-panel");
        const detailName = document.getElementById("detail-name");
        const detailBody = document.getElementById("detail-body");

        document.getElementById("detail-close").addEventListener("click", () => {
            detailPanel.classList.remove("visible");
            pinnedNode = null;
            clearHighlight();
        });

        node.on("click", function(event, d) {
            event.stopPropagation();
            pinnedNode = d;
            applyHighlight(d);

            detailName.textContent = d.name;

            let rows = [
                { key: "Type", value: d.format },
            ];
            if (d.budget_display) {
                rows.push({ key: "Gross Budget", value: d.budget_display });
            }
            if (d.domain) {
                rows.push({ key: "Domain", value: `<a href="${d.domain}" target="_blank">${d.domain.replace(/^https?:\/\//, '')}</a>` });
            }
            // Count connections
            let parentCount = 0, childCount = 0;
            graphData.links.forEach(l => {
                const sid = typeof l.source === 'object' ? l.source.id : l.source;
                const tid = typeof l.target === 'object' ? l.target.id : l.target;
                if (tid === d.id) parentCount++;
                if (sid === d.id) childCount++;
            });
            rows.push({ key: "Parents", value: parentCount });
            rows.push({ key: "Children", value: childCount });

            detailBody.innerHTML = rows.map(r =>
                `<div class="detail-row"><span class="detail-key">${r.key}</span><span class="detail-value">${r.value}</span></div>`
            ).join('');

            detailPanel.classList.add("visible");
        });

        svg.on("click", () => {
            pinnedNode = null;
            detailPanel.classList.remove("visible");
            clearHighlight();
        });

        // Drag behaviour
        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        // Force simulation
        const simulation = d3.forceSimulation(graphData.nodes)
            .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(40).strength(0.15))
            .force("charge", d3.forceManyBody().strength(-50).distanceMax(200))
            .force("x", d3.forceX(width / 2).strength(0.03))
            .force("y", d3.forceY(d => tierY(d.tier)).strength(1.2))
            .force("collide", d3.forceCollide(d => d.radius + 2).strength(0.7))
            .alphaDecay(0.02)
            .on("tick", () => {
                // Clamp X to prevent horizontal leaking
                const xPad = 50;
                graphData.nodes.forEach(d => {
                    d.x = Math.max(xPad, Math.min(width - xPad, d.x));
                });

                // Clamp Y so nodes stay within their tier band
                graphData.nodes.forEach(d => {
                    const centre = tierY(d.tier);
                    const half = tierHeight / 2;
                    d.y = Math.max(centre - half, Math.min(centre + half, d.y));
                });

                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });

        node.call(drag(simulation));

        // No initial zoom-to-fit — chart starts at 1:1 and user zooms/pans as needed
    </script>
</body>
</html>
